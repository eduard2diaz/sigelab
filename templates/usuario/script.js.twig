<script>
    var usuario = function () {
    table = null;
    obj = null;
    var configurarDataTable = function () {
    table = $('table#table_usuario').DataTable({
    "pagingType": "simple_numbers",
    "language": {
    url: datatable_url
},
    columns: [
{data: 'id'},
{data: 'nombre'},
{data: 'apellido'},
{data: 'usuario'},
{data: 'activo'},
{data: 'acciones'}
    ]}
    );
}


    var edicion = function () {
    $('div.m-portlet').on('click', 'a.edicion', function (evento)
{
    evento.preventDefault();
    var link = $(this).attr('data-href');
    obj = $(this);
    $.ajax({
    type: 'get', //Se uso get pues segun los desarrolladores de yahoo es una mejoria en el rendimineto de las peticiones ajax
    dataType: 'html',
    url: link,
    beforeSend: function (data) {
    mApp.block("body", {overlayColor:"#000000",type:"loader",state:"success",message:window.loadingMessage});
},
    success: function (data) {
    if ($('div#basicmodal').html(data)) {
    //configurarFormularioUsuario();
    $('div#basicmodal').modal('show');
    //VALIDANDO FORMULARIO DE REGISTRO DE USUARIO
    $("div#basicmodal form#usuario_new").validate({
        rules:{
            'usuario[nombre]': {required:true},
            'usuario[apellido]': {required:true},
            'usuario[facultad]': {required:true},
            'usuario[correo]': {required:true, email:true},
            'usuario[idrol][]': {required:true},
            'usuario[password][first]': {required:true},
            'usuario[password][second]': {required:true, equalTo: "#usuario_password_first"},
         }
    });
    validarEditUser();
}
},
    error: function ()
{
    //base.Error();
},
    complete: function () {
    mApp.unblock("body")
}
});
});
}
    var refrescar = function () {
    $('div.block-information').on('click', 'a#refrescar', function (evento){
    evento.preventDefault();
    var link = $(this).attr('href');
    obj = $(this);
    $.ajax({
    type: 'get', //Se uso get pues segun los desarrolladores de yahoo es una mejoria en el rendimineto de las peticiones ajax
    dataType: 'html',
    url: link,
    beforeSend: function (data) {
    mApp.block("body", {overlayColor:"#000000",type:"loader",state:"success",message:window.loadingMessage});
},
    success: function (data) {
    $('table#table').html(data);
    table.destroy();
    configurarDataTable();
},
    error: function ()
{
    //base.Error();
},
    complete: function () {
    mApp.unblock("body")
}
});
});
}


    var newAction = function () {
    $('div#basicmodal').on('submit', 'form#usuario_new', function (evento)
{
    evento.preventDefault();
    var padre = $(this).parent();
    var l = Ladda.create(document.querySelector( '.ladda-button' ) );
    l.start();
    $.ajax({
    url: $(this).attr("action"),
    type: "POST",
    data: $(this).serialize(), //para enviar el formulario hay que serializarlo
    beforeSend: function () {
    //   base.blockUI({message: 'Cargando'});
},
    complete: function () {
    l.stop();
    //    mApp.unblock("body")
},
    success: function (data) {
    if (data['error']) {
    padre.html(data['form']);
   // configurarFormularioUsuario();
} else {
    if (data['mensaje'])
    toastr.success(data['mensaje']);

    $('div#basicmodal').modal('hide');
    total += 1;
    var pagina = table.page();
    objeto = table.row.add({
    "id": total,
    "nombre": data['nombre'],
    "apellido": data['apellido'],
    "usuario": data['usuario'],
    "activo": "<span class='badge badge-"+data['badge_color']+"'>"+data['badge_texto']+"</span>",
    "acciones": "<ul class='list-inline'><li><a class='btn btn-default btn-sm edicion' data-href=" + Routing.generate('usuario_show.'+_locale,{id:data['id']}) + ">{{ 'visualize'|trans }}</a></li><li><a class='btn blue btn-block btn-outline btn-sm edicion' data-href=" + Routing.generate('usuario_edit.'+_locale,{id:data['id']}) + "><i class='fa fa-edit'></i>{{ 'edit'|trans }}</a></li><li><a class='btn btn-danger btn-sm  eliminar_usuario' data-href=" + Routing.generate('usuario_delete.'+_locale,{id:data['id']}) + "><i class='fa fa-trash-o'></i>{{ 'delete'|trans }}</a></li></ul>",
});
    objeto.draw();
    table.page(pagina).draw('page');
}
},
    error: function ()
{
    //base.Error();
}
});
});
}

    var eliminar = function () {
    $('table#table_usuario').on('click', 'a.eliminar_usuario', function (evento)
{
    evento.preventDefault();
    var obj = $(this);
    var link = $(this).attr('data-href');

    bootbox.confirm({
    title: "{{ 'user_delete_title'|trans }}",
    message: "<p>{{ 'user_delete_message'|trans }}</p>",
    buttons: {
    confirm: {
    label: '{{ 'confirm_button'|trans }}',
    className: 'blue'
},
    cancel: {
    label: '{{ 'cancel_button'|trans }}',
    className: 'default'
}
},
    callback: function (result) {
    if (result == true)
    $.ajax({
    type: 'get', //Se uso get pues segun los desarrolladores de yahoo es una mejoria en el rendimineto de las peticiones ajax
    // dataType: 'html', esta url se comentarea porque lo k estamos mandando es un json y no un html plano
    url: link,
    beforeSend: function () {
    mApp.block("body", {overlayColor:"#000000",type:"loader",state:"success",message:window.loadingMessage});
},
    complete: function () {
    mApp.unblock("body")
},
    success: function (data) {
    table.row(obj.parents('tr'))
    .remove()
    .draw('page');
    toastr.success(data['mensaje']);;
},
    error: function ()
{
    //base.Error();
}
});
}
});
});
}

    return {
    init: function () {
    $().ready(function () {
    configurarDataTable();
    refrescar();
    newAction();
    edicion();
    eliminar();
}
    );
}
}
}();


</script>


